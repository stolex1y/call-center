# Call center

Простой центр обработки вызовов (ЦОВ), который на вход получает HTTP запрос с указанием номера A и пытается обработать такой
“входящий вызов”.

- [Основные функции](#основные-функции)
- [Примеры HTTP-запросов](#примеры-http-запросов)
- [Задание конфигурационных параметров](#задание-конфигурационных-параметров)
- [Детали реализации](#детали-реализации)

## Основные функции
- запросы на обработку вызовов;
- получение метрик системы:
  - время ожидания;
  - размер очереди;
  - количество занятых операторов;
  - обслуженная нагрузка в Эрлангах;
- ведение журнала вызовов в файле;
- конфигурация с основными параметрами сервиса.

## Примеры HTTP-запросов

https://www.postman.com/restless-desert-559576/workspace/callcenter

## Задание конфигурационных параметров

Для этого необходимо создать файл config.json, в котором перечислить пары ключ-значение.
На данный момент это реализовано в виде одного объекта - т.е. линейно.

Пример задания конфигурации см. [config.json](config.json).

Можно указать следующие параметры:
| Параметр                         | Значение по умолчанию               | Описание                                                                                |
|----------------------------------|-------------------------------------|-----------------------------------------------------------------------------------------|
| `call_max_wait`                  | 30                                  | Максимальное время ожидания вызова в очереди в секундах                                 |
| `configuration_is_caching`       | true                                | Если false, то при каждом обращении к параметру будет считываться конфигурация из файла |
| `configuration_updating_period`  | 10                                  | Период обновления конфигурации в минутах                                                |
| `http_server_port`               | 8080                                | Порт, на котором будут приниматься запросы                                              |
| `journal_file_name`              | journal.csv                         | Название файла, в котором будут сохраняться записи вызовов (CDR)                        |
| `journal_max_size`               | 18446744073709551615                | Максимальный размер журнала в Мб                                                        |
| `log_severity_level`             | INFO                                | Уровень логирования: "TRACE", "DEBUG", "INFO", "WARNING", "ERROR", "FATAL",             |
| `metrics_update_time`            | 10                                  | Период обновления метрик в секундах                                                     |
| `operator_min_delay`             | 10                                  | Минимальное время обслуживания вызова операторов в секундах                             |
| `operator_max_delay`             | 60                                  | Максимальное время обслуживания вызова операторов в секундах                            |
| `operator_count`                 | 10                                  | Количество обслуживающих операторов                                                     |
| `queue_capacity`                 | 10                                  | Максимальный размер очереди                                                             |
| `task_manager_user_thread_count` | 'Кол-во потоков в системе'          | Количество потоков, выделенное на обработку пользовательских задач                      |
| `task_manager_io_thread_count`   | max('Кол-во потоков в системе', 64) | Количество потоков, выделенное на обработку задач ввода-вывода                          |

## Детали реализации

Когда в систему поступает вызов, он распределяется на свободного оператора либо ставиться в очередь.
Обслуживание вызова представляет собой задержку на случайное время, определяемое конфигурацией.
При этом возможны следующие ситуации: 
- если количество вызовов в очереди максимально, то запрос отклоняется с результатом 'overload';
- если время ожидания в очереди превышено, то запрос отклоняется с результатом 'timeout';
- если запрос с таким номером уже есть в очереди или на обслуживании, то запрос отклоняется с результатом 'already in queue'.

Каждый вызов фиксируется в журнале, который представляет собой файл csv:
- дата и время поступления вызова;
- идентификатор входящего вызова (Call ID);
- номер абонента А;
- дата и время завершения вызова;
- статус вызова;
- дата и время ответа оператора (если был или пустое значение);
- идентификатор оператора (пустое значение если соединение не состоялось);
- длительность разговора (пустое значение если соединение не состоялось).

Конфигурация системы периодически прочитывается из файла. Время задается в конфигурации. 
Кроме того, также в конфигурации можно отключить кеширование, что позволяет считывать значения из файла каждый раз при обращении к параметрам.

Для выполнения пользовательских задач, а также зада ввода-вывода, реализован менеджер задач.
В нем определены два пула потоков для каждого типа задач. 
Кроме того, для тестирования реализован специальный менеджер задач, в котором можно передвигать время на заданный промежуток. Это использовалось, например, при тестировании класса ЦОВ, в котором вызовы ставились в очередь, но вместо ожидания обслуживания, время можно было сразу перевести вперед.
